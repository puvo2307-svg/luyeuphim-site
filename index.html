<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lu Y√™u Phim ‚Äì Trang th√¥ng tin / t·ªïng h·ª£p li√™n k·∫øt</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="logo.png" />
    <link rel="apple-touch-icon" href="logo.png" />
    
    <!-- Open Graph / Facebook / Zalo -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.xemfulltap.live/" />
    <meta property="og:title" id="og-title" content="Lu Y√™u Phim ‚Äì Trang th√¥ng tin / t·ªïng h·ª£p li√™n k·∫øt" />
    <meta property="og:description" id="og-description" content="Xem phim mi·ªÖn ph√≠, t·ªïng h·ª£p c√°c b·ªô phim hay nh·∫•t" />
    <meta property="og:image" id="og-image" content="https://www.xemfulltap.live/logo.png" />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" id="twitter-title" content="Lu Y√™u Phim ‚Äì Trang th√¥ng tin / t·ªïng h·ª£p li√™n k·∫øt" />
    <meta name="twitter:description" id="twitter-description" content="Xem phim mi·ªÖn ph√≠, t·ªïng h·ª£p c√°c b·ªô phim hay nh·∫•t" />
    <meta name="twitter:image" id="twitter-image" content="https://www.xemfulltap.live/logo.png" />
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            text-align: center;
            background: #121212;
            color: white;
            padding: 15px;
            margin: 0;
        }

        /* === CH·∫∂N PC === */
        #pc-blocked {
            display: none;
            height: 100vh;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        #pc-blocked h1 { color: #ee4d2d; }

        /* === N·ªòI DUNG CH√çNH === */
        #mobile-content {
            display: none;
            max-width: 900px;
            margin: 0 auto;
        }

        /* === PLAYER 9:16 === */
        .player-container { 
            position: relative; 
            width: 100%;
            max-width: 480px;
            margin: 0 auto 20px;
            background: #000;
            aspect-ratio: 9/16;
            max-height: calc(100vh - 220px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            border-radius: 12px;
            overflow: hidden;
        }
        iframe { width: 100%; height: 100%; border: none; }
        
        /* === EXTERNAL VIDEO PLACEHOLDER (T·∫≠p 1 v·ªõi Fanpage link) === */
        #external-video-placeholder {
            position: relative;
            width: 100%;
            height: 100%;
            background: #1a1a1a;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-radius: 12px;
            overflow: hidden;
        }
        #external-video-placeholder.active {
            display: flex;
        }
        #external-video-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 0.7;
            display: block;
            z-index: 1;
        }
        #external-video-play-btn {
            position: relative;
            z-index: 10;
            width: 80px;
            height: 80px;
            background: rgba(238, 77, 45, 0.95);
            border-radius: 50%;
            display: flex !important;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5);
            transition: transform 0.2s;
            cursor: pointer;
        }
        #external-video-play-btn:active {
            transform: scale(0.95);
        }
        #external-video-label {
            position: relative;
            z-index: 10;
            margin-top: 20px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            padding: 0 20px;
            display: block !important;
        }
        
        /* === OVERLAY SHOPEE === */
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); /* Trong su·ªët h∆°n ƒë·ªÉ th·∫•y video ph√≠a sau */
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 99; cursor: pointer;
            padding: 20px;
        }
        .btn-shopee-main {
            background: linear-gradient(135deg, #ff5722 0%, #ee4d2d 100%);
            color: white; border: none; padding: 18px 35px;
            font-size: 18px; font-weight: bold; border-radius: 50px; cursor: pointer;
            box-shadow: 0 8px 15px rgba(238, 77, 45, 0.4);
            text-transform: uppercase; letter-spacing: 1px;
        }
        .text-support { color: #f1c40f; font-size: 16px; margin-bottom: 15px; font-weight: 500; }
        .text-note { color: #777; font-size: 13px; margin-top: 15px; line-height: 1.4; }

        /* === EPISODE LIST === */
        .episode-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 10px; padding: 15px;
            background: #1e1e1e; border-radius: 15px;
        }
        .ep-item {
            background: #333; color: #ccc; border: 1px solid #444;
            padding: 12px 5px; cursor: pointer; border-radius: 8px;
            font-weight: 500; font-size: 14px;
        }
        .ep-item.active { background: #ee4d2d; color: white; border-color: #ee4d2d; font-weight: bold; }
        .ep-item.uploading { background: #222; color: #555; border: 1px dashed #444; cursor: not-allowed; }

        /* === T√åM KI·∫æM === */
        .search-container { margin-bottom: 16px; text-align: left; }
        .search-title { font-size: 22px; font-weight: 600; margin-bottom: 6px; }
        .search-desc { font-size: 13px; color: #bbb; margin-bottom: 8px; }
        .search-input {
            width: 100%; padding: 10px 12px; border-radius: 8px;
            border: 1px solid #444; background: #1b1b1b; color: #eee; font-size: 14px;
        }
        .search-results {
            margin-top: 6px; max-height: 160px; overflow-y: auto;
            border-radius: 8px; border: 1px solid #333; background: #181818;
        }
        .search-result-item {
            padding: 8px 10px; font-size: 13px; cursor: pointer; border-bottom: 1px solid #222;
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: #262626; }

        /* === TOP PHIM (GRID LAYOUT - CU·ªòN D·ªåC) === */
        .top-section { margin-top: 18px; text-align: left; }
        .top-title { font-size: 17px; font-weight: 600; margin-bottom: 10px; }
        .top-grid {
            display: grid;
            gap: 10px;
            /* Mobile: 4 c·ªôt */
            grid-template-columns: repeat(4, 1fr);
            /* PC: responsive, t·ªëi ƒëa 10 c·ªôt */
        }
        /* Responsive cho PC */
        @media (min-width: 600px) {
            .top-grid { grid-template-columns: repeat(5, 1fr); }
        }
        @media (min-width: 768px) {
            .top-grid { grid-template-columns: repeat(6, 1fr); }
        }
        @media (min-width: 900px) {
            .top-grid { grid-template-columns: repeat(7, 1fr); }
        }
        @media (min-width: 1024px) {
            .top-grid { grid-template-columns: repeat(8, 1fr); }
        }
        @media (min-width: 1200px) {
            .top-grid { grid-template-columns: repeat(9, 1fr); }
        }
        @media (min-width: 1400px) {
            .top-grid { grid-template-columns: repeat(10, 1fr); }
        }
        .top-card {
            width: 100%;
            background: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .top-card:hover { transform: scale(1.03); }
        .top-card-wrapper { position: relative; }
        .top-card-img {
            width: 100%;
            aspect-ratio: 3/4;
            object-fit: cover;
            background: #222;
            display: block;
        }
        /* No Pic placeholder */
        .top-card-nopic {
            width: 100%;
            aspect-ratio: 3/4;
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #555;
            font-size: 11px;
            font-weight: 500;
        }
        .top-card-rank {
            position: absolute;
            top: 4px; left: 4px;
            background: #ee4d2d;
            color: #fff;
            font-size: 10px;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .top-card-name {
            padding: 5px 4px;
            font-size: 10px;
            color: #ccc;
            line-height: 1.3;
            text-align: center;
            height: 30px; /* 2 d√≤ng x 13px */
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        /* T√≥m t·∫Øt phim: m·∫∑c ƒë·ªãnh ch·ªâ hi·ªÉn th·ªã 2 d√≤ng, c√≥ th·ªÉ m·ªü r·ªông */
        #film-summary {
            margin-top: 8px;
            margin-bottom: 12px;
            font-size: 14px;
            color: #ccc;
            line-height: 1.5;
            text-align: left;
            display: none;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        #film-summary.expanded {
            display: block;
            overflow: visible;
            -webkit-line-clamp: unset;
            display: block;
        }
        #film-summary-toggle {
            display: none;
            font-size: 12px;
            color: #999;
            cursor: pointer;
            margin-top: -4px;
            margin-bottom: 8px;
            text-align: right;
        }
        #film-summary-toggle span {
            text-decoration: underline;
        }

        /* === BANNER CAROUSEL === */
        .banner-container {
            width: 100%;
            height: 200px; /* Mobile */
            position: relative;
            margin: 16px 0;
            border-radius: 12px;
            overflow: hidden;
            background: #1a1a1a;
        }
        @media (min-width: 900px) {
            .banner-container {
                height: 400px; /* PC - cao h∆°n */
            }
        }
        .banner-wrapper {
            display: flex;
            width: 100%;
            height: 100%;
            transition: transform 0.5s ease-in-out;
        }
        .banner-slide {
            min-width: 100%;
            height: 100%;
            position: relative;
        }
        .banner-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .banner-prev, .banner-next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            z-index: 10;
            transition: background 0.3s;
        }
        .banner-prev:hover, .banner-next:hover {
            background: rgba(0,0,0,0.8);
        }
        .banner-prev { left: 10px; }
        .banner-next { right: 10px; }
        .banner-dots {
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            z-index: 10;
        }
        .banner-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: all 0.3s;
        }
        .banner-dot.active {
            background: #ee4d2d;
            width: 24px;
            border-radius: 4px;
        }

        /* === LINK BUTTONS === */
        .link-buttons { margin-top: 16px; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .link-btn {
            padding: 8px 14px; border-radius: 999px; border: 1px solid #333;
            background: #1e1e1e; color: #f5f5f5; font-size: 13px;
            cursor: pointer; text-decoration: none; white-space: nowrap;
        }
        .link-btn:hover { background: #333; }
        .link-btn-primary { border-color: #ee4d2d; background: #ee4d2d; }
        .link-btn-primary:hover { background: #ff6a3a; }

        /* === DONATE BOX === */
        .donate-box {
            margin-top: 18px; padding: 12px 14px; background: #181818;
            border-radius: 10px; border: 1px solid #333; font-size: 13px; text-align: left;
        }
        .donate-text-title { font-weight: 600; color: #f1c40f; margin-bottom: 4px; }
        .donate-text-sub { color: #aaa; line-height: 1.4; }
        .donate-text-sub strong.stk { color: #ff6a3a; font-size: 15px; font-weight: bold; } /* M√†u cam cho STK */

        /* === DONATE MODAL === */
        .donate-modal-backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7);
            display: none; align-items: center; justify-content: center; z-index: 9999;
        }
        .donate-modal {
            background: #181818; border-radius: 12px; padding: 18px 20px;
            border: 1px solid #333; max-width: 320px; width: 90%;
            text-align: left; box-shadow: 0 8px 20px rgba(0,0,0,0.6); font-size: 14px;
        }
        .donate-modal-title { font-weight: 600; margin-bottom: 8px; color: #f1c40f; }
        .donate-modal-close {
            margin-top: 14px; width: 100%; padding: 8px 0; border-radius: 8px;
            border: none; background: #ee4d2d; color: white; font-weight: 600; cursor: pointer;
        }
    </style>
</head>
<body>

<!-- ========== CH·∫∂N PC ========== -->
<div id="pc-blocked">
    <!-- D·∫£i phim ƒë·ªÅ xu·∫•t ch·ªâ ƒë·ªÉ xem, kh√¥ng click, kh√¥ng m·ªü Shopee -->
    <div id="top-section-pc" class="top-section" style="max-width: 900px; width: 100%; margin-bottom: 24px;">
        <div class="top-title">üì∫ Phim ƒë·ªÅ xu·∫•t</div>
        <div id="top-grid-pc" class="top-grid" style="cursor: default;"></div>
    </div>

    <h1>‚ö†Ô∏è TH√îNG B√ÅO</h1>
    <p>N·ªôi dung n√†y hi·ªán ch·ªâ h·ªó tr·ª£ xem tr√™n <strong>Thi·∫øt b·ªã di ƒë·ªông (Mobile)</strong>.</p>
    <p style="margin-top: 10px; max-width: 700px; font-size: 14px; color: #ccc;">
        H√£y nh·∫≠p <strong>xemfulltap.live</strong> tr√™n tr√¨nh duy·ªát <strong>mobile</strong> ƒë·ªÉ t√¨m phim r·ªìi xem, ho·∫∑c xem c√°c phim ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t. Xin c·∫£m ∆°n!
    </p>
    <div style="margin-top: 20px; color: #555;">(H·ªó tr·ª£: Android, iPhone, iPad)</div>

    <div class="link-buttons">
        <a id="fanpage-link-pc" class="link-btn" href="#" target="_blank" rel="noopener noreferrer">Tham gia nh√≥m Fanpage</a>
        <a id="youtube-link-pc" class="link-btn" href="#" target="_blank" rel="noopener noreferrer">Theo d√µi &amp; nh·∫•n chu√¥ng YTB</a>
    </div>

    <div class="donate-box" style="max-width: 900px; margin: 20px auto 0 auto;">
        <div class="donate-text-sub" id="donate-content-pc">
            V√¨ v·∫•n ƒë·ªÅ b·∫£n quy·ªÅn n√™n th·ªùi l∆∞·ª£ng c√°c t·∫≠p phim kh√° ng·∫Øn, mong m·ªçi ng∆∞·ªùi th√¥ng c·∫£m cho team üôá<br><br>
            To√†n b·ªô phim tr√™n xemfulltap.live ƒë·ªÅu l√† mi·ªÖn ph√≠, ch√∫ng m√¨nh ch·ªâ ƒë·∫∑t click shopee ƒë·ªÉ duy tr√¨ ho·∫°t ƒë·ªông. C·∫£m ∆°n c√°c b·∫°n ƒë√£ ·ªßng h·ªô v√† h√£y chia s·∫ª n·∫øu th·∫•y hay nha!!!
        </div>
    </div>

    <div style="max-width: 900px; margin: 20px auto 0 auto; font-size: 12px; color: #888; text-align: left; padding: 0 12px;">
        <strong>L∆∞u √Ω:</strong> Ph·∫ßn d·ªãch + l·ªìng ti·∫øng (AI) t·∫°o b·ªüi team Lu Y√™u Phim. Video g·ªëc l·∫•y t·ª´ c√°c ngu·ªìn ph·ªï bi·∫øn tr√™n Internet. N·∫øu b·∫°n cho r·∫±ng quy·ªÅn l·ª£i b·ªã ·∫£nh h∆∞·ªüng, vui l√≤ng li√™n h·ªá ƒë·ªÉ g·ª°. Fanpage: <a href="https://www.facebook.com/luyeuphim.dramashorts/" target="_blank" rel="noopener noreferrer" style="color: #ee4d2d; text-decoration: underline;"><strong>Lu Y√™u Phim</strong></a>
    </div>
</div>

<!-- ========== N·ªòI DUNG MOBILE ========== -->
<div id="mobile-content">
    <!-- T√åM KI·∫æM -->
    <div class="search-container">
        <div class="search-title">T√¨m phim theo t√™n ti·∫øng Vi·ªát</div>
        <div class="search-desc">
            Nh·∫≠p <strong>t√™n phim</strong> gi·ªëng nh∆∞ m√¥ t·∫£ tr√™n Fanpage/TikTok m√† b·∫°n ƒë√£ xem. V√≠ d·ª•: <em>"Ch√†ng Trai Xuy√™n Kh√¥ng X√¢y D·ª±ng ƒê·∫ø Ch·∫ø B·ªã V·ª£ C·∫Øm S·ª´ng C∆∞·ªõp C√¥ng V√† C√°i K·∫øt L√†m Ch·ªìng N·ªØ ƒê·∫ø"</em>
        </div>
        <div class="search-desc" style="margin-top: 6px;">
            L∆∞u √Ω: Mu·ªën xem ·ªïn ƒë·ªãnh/ƒë·∫ßy ƒë·ªß, h√£y m·ªü b·∫±ng <strong>Safari (iOS)</strong> ho·∫∑c <strong>tr√¨nh duy·ªát Chrome (Android)</strong>.
        </div>
        <input id="search-input" class="search-input" type="text" placeholder="Nh·∫≠p T√™n Phim Vi·ªát ƒë·ªÉ t√¨m..." autocomplete="off" />
        <div id="search-results" class="search-results" style="display:none;"></div>
    </div>

    <!-- BANNER CAROUSEL -->
    <div id="banner-carousel" class="banner-container" style="display:none;">
        <div class="banner-wrapper"></div>
        <div class="banner-dots"></div>
        <button class="banner-prev">‚Äπ</button>
        <button class="banner-next">‚Ä∫</button>
    </div>

    <!-- PHIM ƒê·ªÄ XU·∫§T (TOP) - HI·ªÇN TH·ªä ·∫¢NH B√åA -->
    <div id="top-section" class="top-section" style="display:none;">
        <div class="top-title">üì∫ Phim ƒë·ªÅ xu·∫•t</div>
        <div id="top-grid" class="top-grid"></div>
    </div>

    <!-- PHIM THEO TH·ªÇ LO·∫†I -->
    <div id="genre-section" class="genre-section" style="display:none;">
        <div class="top-title">üé¨ Phim theo th·ªÉ lo·∫°i</div>
        <div id="genre-tabs" class="genre-tabs"></div>
        <div id="genre-grid" class="top-grid"></div>
    </div>

    <!-- N√öT C·ªòNG ƒê·ªíNG -->
    <div class="link-buttons">
        <a id="fanpage-link" class="link-btn" href="#" target="_blank" rel="noopener noreferrer">Tham gia nh√≥m Fanpage</a>
        <a id="youtube-link" class="link-btn" href="#" target="_blank" rel="noopener noreferrer">Theo d√µi &amp; nh·∫•n chu√¥ng YTB</a>
    </div>

    <div class="donate-box">
        <div class="donate-text-sub" id="donate-content">
            V√¨ v·∫•n ƒë·ªÅ b·∫£n quy·ªÅn n√™n th·ªùi l∆∞·ª£ng c√°c t·∫≠p phim kh√° ng·∫Øn, mong m·ªçi ng∆∞·ªùi th√¥ng c·∫£m cho team üôá<br><br>
            To√†n b·ªô phim tr√™n xemfulltap.live ƒë·ªÅu l√† mi·ªÖn ph√≠, ch√∫ng m√¨nh ch·ªâ ƒë·∫∑t click shopee ƒë·ªÉ duy tr√¨ ho·∫°t ƒë·ªông. C·∫£m ∆°n c√°c b·∫°n ƒë√£ ·ªßng h·ªô v√† h√£y chia s·∫ª n·∫øu th·∫•y hay nha!!!
        </div>
    </div>

    <!-- KHU V·ª∞C XEM PHIM (·∫®N CHO ƒê·∫æN KHI CH·ªåN PHIM) -->
    <div id="movie-section" style="display:none; margin-top: 16px;">
        <h2 id="film-title" style="font-size: 20px;">T·∫≠p 1 - T√™n Phim C·ªßa B·∫°n</h2>
        <div id="film-summary"></div>
        <div id="film-summary-toggle"><span>Xem th√™m</span></div>

    <div class="player-container">
            <!-- Overlay Shopee ƒë√£ ƒë∆∞·ª£c t·∫Øt ho√†n to√†n -->
            <div id="overlay" style="display: none !important;"></div>
            <!-- Placeholder cho video ngo√†i (T·∫≠p 1 v·ªõi Fanpage link) -->
            <div id="external-video-placeholder" onclick="openExternalVideo()">
                <img id="external-video-thumbnail" src="" alt="Video thumbnail" style="display: block;" onerror="this.style.display='none'">
                <div id="external-video-play-btn" style="display: flex !important;">‚ñ∂</div>
                <div id="external-video-label" style="display: block !important;">Xem tr√™n Fanpage</div>
            </div>
            <!-- autoplay m·∫∑c ƒë·ªãnh =1, t·∫Øt overlay ƒë·ªÉ ng∆∞·ªùi d√πng ch·ªß ƒë·ªông Play n·∫øu mu·ªën -->
            <iframe id="video-player" src="" allow="fullscreen" allowfullscreen></iframe>
        </div>

        <div id="episode-list" class="episode-list"></div>

        <div style="margin-top: 14px; font-size: 12px; color: #888; text-align: left;">
            <strong>L∆∞u √Ω:</strong> Ph·∫ßn d·ªãch + l·ªìng ti·∫øng (AI) t·∫°o b·ªüi team Lu Y√™u Phim. Video g·ªëc l·∫•y t·ª´ c√°c ngu·ªìn ph·ªï bi·∫øn tr√™n Internet. N·∫øu b·∫°n cho r·∫±ng quy·ªÅn l·ª£i b·ªã ·∫£nh h∆∞·ªüng, vui l√≤ng li√™n h·ªá ƒë·ªÉ g·ª°. Fanpage: <a href="https://www.facebook.com/luyeuphim.dramashorts/" target="_blank" rel="noopener noreferrer" style="color: #ee4d2d; text-decoration: underline;"><strong>Lu Y√™u Phim</strong></a>
        </div>
    </div>
    </div>


    <script>
// ========== KI·ªÇM TRA THI·∫æT B·ªä ==========
function checkDevice() {
    var ua = navigator.userAgent || navigator.vendor || window.opera;
    var isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile|CriOS/i.test(ua);
    
    // Th√™m check m√†n h√¨nh nh·ªè (fallback)
    if (!isMobile && window.innerWidth <= 900 && 'ontouchstart' in window) {
        isMobile = true;
    }

    var mobileContent = document.getElementById('mobile-content');
    var pcBlocked = document.getElementById('pc-blocked');

    if (isMobile) {
        if (mobileContent) mobileContent.style.display = 'block';
        if (pcBlocked) pcBlocked.style.display = 'none';
    } else {
        if (mobileContent) mobileContent.style.display = 'none';
        if (pcBlocked) pcBlocked.style.display = 'flex';
    }
}

// Ch·∫°y ngay v√† ch·∫°y l·∫°i khi load xong
checkDevice();
window.addEventListener('load', checkDevice);
window.addEventListener('resize', checkDevice);

// ========== LOAD CONFIG (Donate, Social Links, Meta) ==========
var SITE_CONFIG_URL = "https://raw.githubusercontent.com/puvo2307-svg/luyeuphim-site/main/site-config.json";
var siteConfig = null;

function loadSiteConfig() {
    fetch(SITE_CONFIG_URL)
        .then(function(res) {
            if (!res.ok) {
                throw new Error("Kh√¥ng th·ªÉ load config: " + res.status);
            }
            return res.json();
        })
        .then(function(config) {
            siteConfig = config;
            updateDonateInfo();
            updateSocialLinks();
            updateMetaTags();
        })
        .catch(function(e) {
            console.error("L·ªói load config:", e);
            // D√πng gi√° tr·ªã m·∫∑c ƒë·ªãnh n·∫øu load l·ªói
            useDefaultConfig();
        });
}

function useDefaultConfig() {
    siteConfig = {
        donate: {
            title: "·ª¶ng h·ªô duy tr√¨ k√™nh",
            bank: "MB Bank",
            accountName: "LE THI TUYET HOA",
            accountNumber: "9323082004",
            note: "Ung ho Lu Yeu Phim",
            message: "C·∫£m ∆°n b·∫°n ƒë√£ ·ªßng h·ªô ƒë·ªÉ k√™nh c√≥ th·ªÉ duy tr√¨ ho·∫°t ƒë·ªông l√¢u d√†i."
        },
        social: {
            fanpage: "https://www.facebook.com/groups/luyeuphim",
            youtube: "https://youtube.com/channel/UCb35SXg3vJeYP5povmGHA1A?sub_confirmation=1",
            fanpageContact: "https://www.facebook.com/luyeuphim.dramashorts/",
            youtubeRedirect: "https://youtube.com/channel/UCb35SXg3vJeYP5povmGHA1A?sub_confirmation=1"
        }
    };
    updateDonateInfo();
    updateSocialLinks();
}

function updateDonateInfo() {
    if (!siteConfig || !siteConfig.donate) return;
    var d = siteConfig.donate;
    
    // Update donate box (mobile)
    var titleEl = document.getElementById('donate-title');
    if (titleEl) titleEl.textContent = d.title || "·ª¶ng h·ªô duy tr√¨ k√™nh";
    
    var bankEl = document.getElementById('donate-bank');
    if (bankEl) bankEl.textContent = d.bank || "MB Bank";
    
    var accountNameEl = document.getElementById('donate-account-name');
    if (accountNameEl) accountNameEl.textContent = d.accountName || "LE THI TUYET HOA";
    
    var accountNumberEl = document.getElementById('donate-account-number');
    if (accountNumberEl) accountNumberEl.textContent = d.accountNumber || "9323082004";
    
    var noteEl = document.getElementById('donate-note');
    if (noteEl) noteEl.textContent = d.note || "Ung ho Lu Yeu Phim";
    
    var messageEl = document.getElementById('donate-message');
    if (messageEl) messageEl.textContent = d.message || "C·∫£m ∆°n b·∫°n ƒë√£ ·ªßng h·ªô ƒë·ªÉ k√™nh c√≥ th·ªÉ duy tr√¨ ho·∫°t ƒë·ªông l√¢u d√†i.";
    
    // Update donate modal
    var modalTitleEl = document.getElementById('donate-modal-title');
    if (modalTitleEl) modalTitleEl.textContent = d.title || "·ª¶ng h·ªô duy tr√¨ k√™nh";
    
    var modalBankEl = document.getElementById('donate-modal-bank');
    if (modalBankEl) modalBankEl.textContent = d.bank || "MB Bank";
    
    var modalAccountNameEl = document.getElementById('donate-modal-account-name');
    if (modalAccountNameEl) modalAccountNameEl.textContent = d.accountName || "LE THI TUYET HOA";
    
    var modalAccountNumberEl = document.getElementById('donate-modal-account-number');
    if (modalAccountNumberEl) modalAccountNumberEl.textContent = d.accountNumber || "9323082004";
    
    var modalNoteEl = document.getElementById('donate-modal-note');
    if (modalNoteEl) modalNoteEl.textContent = d.note || "Ung ho Lu Yeu Phim";
    
    var modalMessageEl = document.getElementById('donate-modal-message');
    if (modalMessageEl) modalMessageEl.textContent = d.message || "C·∫£m ∆°n b·∫°n ƒë√£ ·ªßng h·ªô ƒë·ªÉ k√™nh c√≥ th·ªÉ duy tr√¨ ho·∫°t ƒë·ªông l√¢u d√†i.";
}

function updateSocialLinks() {
    if (!siteConfig || !siteConfig.social) return;
    var s = siteConfig.social;
    
    // Mobile links
    var fanpageLink = document.getElementById('fanpage-link');
    if (fanpageLink && s.fanpage) {
        fanpageLink.href = s.fanpage;
    }
    
    var youtubeLink = document.getElementById('youtube-link');
    if (youtubeLink && s.youtube) {
        youtubeLink.href = s.youtube;
    }
    
    // PC links
    var fanpageLinkPc = document.getElementById('fanpage-link-pc');
    if (fanpageLinkPc && s.fanpage) {
        fanpageLinkPc.href = s.fanpage;
    }
    
    var youtubeLinkPc = document.getElementById('youtube-link-pc');
    if (youtubeLinkPc && s.youtube) {
        youtubeLinkPc.href = s.youtube;
    }
}

function updateMetaTags() {
    if (!siteConfig || !siteConfig.meta) return;
    var m = siteConfig.meta;
    
    if (m.title) {
        document.title = m.title;
        var ogTitle = document.getElementById('og-title');
        if (ogTitle) ogTitle.content = m.title;
        var twitterTitle = document.getElementById('twitter-title');
        if (twitterTitle) twitterTitle.content = m.title;
    }
    
    if (m.description) {
        var ogDesc = document.getElementById('og-description');
        if (ogDesc) ogDesc.content = m.description;
        var twitterDesc = document.getElementById('twitter-description');
        if (twitterDesc) twitterDesc.content = m.description;
    }
    
    if (m.image) {
        var ogImage = document.getElementById('og-image');
        if (ogImage) ogImage.content = m.image;
        var twitterImage = document.getElementById('twitter-image');
        if (twitterImage) twitterImage.content = m.image;
    }
}

// ========== LOAD D·ªÆ LI·ªÜU T·ª™ JSON (Export t·ª´ Sheet) ==========
// URL JSON file (s·∫Ω ƒë∆∞·ª£c export t·ª± ƒë·ªông t·ª´ Sheet m·ªói 10 ph√∫t)
// Th√™m timestamp ƒë·ªÉ tr√°nh cache
var MOVIES_JSON_URL = "https://raw.githubusercontent.com/puvo2307-svg/luyeuphim-site/main/movies.json?t=" + Date.now();
// Fallback n·∫øu JSON l·ªói th√¨ load t·ª´ Sheet tr·ª±c ti·∫øp

var movieIndex = {};
var banners = []; // Danh s√°ch banner t·ª´ c·ªôt N
var currentEpisode = null;
var pendingOpen = null; // { id, ep } from URL hash

function normalizeText(str) {
    return String(str || "")
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/ƒë/g, 'd').replace(/ƒê/g, 'D')
        .replace(/\s+/g, ' ')
        .trim();
}

function loadMoviesFromJSON() {
    // Th√™m timestamp ƒë·ªÉ tr√°nh cache (m·ªói l·∫ßn load ƒë·ªÅu c√≥ timestamp m·ªõi)
    var jsonUrl = "https://raw.githubusercontent.com/puvo2307-svg/luyeuphim-site/main/movies.json?t=" + Date.now();
    fetch(jsonUrl, { cache: 'no-store' })
        .then(function(res) {
            if (!res.ok) {
                throw new Error("Kh√¥ng th·ªÉ load JSON: " + res.status);
            }
            return res.json();
        })
        .then(function(data) {
            // Reset
            movieIndex = {};
            banners = [];

            // Parse JSON format t·ª´ export script: { movies: [...], banners: [...] }
            var movies = data.movies || [];
            banners = data.banners || [];

            movies.forEach(function(movie) {
                var filmId = movie.name || ""; // T√™n B·ªô Phim (A)
                if (!filmId) return;

                var displayName = movie.vietName || movie.name || "";
                
                movieIndex[filmId] = {
                    episodes: movie.episodes || [],
                    topRank: movie.top || null,
                    poster: movie.poster || "",
                    displayName: displayName,
                    summary: movie.summary || "",  // T√≥m t·∫Øt phim
                    allowPC: movie.allowPC === true || movie.allowPC === 1,
                    year: movie.year || "",
                    genre: (movie.genre && movie.genre.trim()) ? movie.genre.trim() : "",
                    country: movie.country || ""
                };
                
                // Debug: log genre khi load t·ª´ JSON
                if (movieIndex[filmId].genre) {
                    console.log("üìù Load t·ª´ JSON - Phim:", filmId, "Genre:", movieIndex[filmId].genre);
                }

                // Sort episodes
                movieIndex[filmId].episodes.sort(function(a, b) {
                    return (a.ep || 0) - (b.ep || 0);
                });
            });

            renderTopMovies();
            initGenreTabs(); // Kh·ªüi t·∫°o tabs v√† render phim theo th·ªÉ lo·∫°i
            if (banners.length > 0) {
                renderBanners();
            }

            // N·∫øu URL hash c√≥ phim/t·∫≠p th√¨ t·ª± m·ªü l·∫°i ƒë√∫ng tr·∫°ng th√°i
            if (pendingOpen && pendingOpen.id && movieIndex[pendingOpen.id]) {
                loadMovieById(pendingOpen.id, { preferredEp: pendingOpen.ep, fromHash: true });
            }
        })
        .catch(function(e) {
            console.error("L·ªói load JSON:", e);
            // Fallback: th·ª≠ load t·ª´ Sheet n·∫øu JSON l·ªói
            console.log("Th·ª≠ fallback load t·ª´ Sheet...");
            loadMoviesFromSheetFallback();
        });
}

// Fallback: Load t·ª´ Sheet tr·ª±c ti·∫øp (n·∫øu JSON ch∆∞a c√≥)
function loadMoviesFromSheetFallback() {
    var SHEET_JSON_URL = "https://docs.google.com/spreadsheets/d/1KxEhDNIH7AdgSBSL05s4jQnPghLOo2MI8wvgBxTXv7w/gviz/tq?tqx=out:json&sheet=Sheet4";
    console.log("üì• ƒêang load t·ª´ Sheet fallback:", SHEET_JSON_URL);
    fetch(SHEET_JSON_URL)
        .then(function(res) { return res.text(); })
        .then(function(text) {
            var jsonStr = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
            var data = JSON.parse(jsonStr);
            var rows = data.table.rows || [];

            movieIndex = {};
            banners = [];
            var filmToVietName = {};

            // Pass 1: gom T√™n Phim Vi·ªát
            rows.forEach(function(row) {
                var cells = row.c || [];
                var filmA = (cells[0] && cells[0].v) ? String(cells[0].v).trim() : "";
                var tenPhimViet = (cells[6] && cells[6].v) ? String(cells[6].v).trim() : "";
                if (filmA && tenPhimViet && !filmToVietName[filmA]) {
                    filmToVietName[filmA] = tenPhimViet;
                }
            });

            // Pass 2: build index
            rows.forEach(function(row) {
                var cells = row.c || [];
                var filmA = (cells[0] && cells[0].v) ? String(cells[0].v).trim() : "";
                var ep = (cells[1] && cells[1].v != null) ? Number(cells[1].v) : null;
                var embedUrl = (cells[3] && cells[3].v) ? String(cells[3].v).trim() : "";
                var summary = (cells[7] && cells[7].v) ? String(cells[7].v).trim() : ""; // C·ªôt H: T√≥m t·∫Øt phim
                var topRaw = (cells[8] && cells[8].v != null) ? Number(cells[8].v) : null; // C·ªôt I: TOP
                var poster = (cells[9] && cells[9].v) ? String(cells[9].v).trim() : ""; // C·ªôt J: Poster URL
                var banner = (cells[14] && cells[14].v) ? String(cells[14].v).trim() : ""; // C·ªôt O: Banner

                // X·ª≠ l√Ω banner kh√¥ng c√≥ phim (ch·ªâ c√≥ c·ªôt O)
                if (!filmA && banner && banner.startsWith("http")) {
                    var bannerExists = false;
                    for (var i = 0; i < banners.length; i++) {
                        if (typeof banners[i] === 'object' && banners[i].url === banner) {
                            bannerExists = true;
                            break;
                        } else if (typeof banners[i] === 'string' && banners[i] === banner) {
                            bannerExists = true;
                            break;
                        }
                    }
                    if (!bannerExists) {
                        banners.push({
                            url: banner,
                            movieId: null  // Banner kh√¥ng g·∫Øn v·ªõi phim n√†o
                        });
                    }
                    return; // Skip d√≤ng n√†y, kh√¥ng x·ª≠ l√Ω phim
                }

                if (!filmA || !embedUrl || ep == null) return;

                var resolvedViet = filmToVietName[filmA] || "";
                var displayName = resolvedViet || filmA;

                if (!movieIndex[filmA]) {
                    movieIndex[filmA] = { 
                        episodes: [], 
                        topRank: null, 
                        poster: "", 
                        displayName: displayName, 
                        summary: "",  // T√≥m t·∫Øt phim
                        allowPC: false,
                        genre: ""  // Th·ªÉ lo·∫°i
                    };
                }
                movieIndex[filmA].displayName = displayName;
                
                // C·∫≠p nh·∫≠t t√≥m t·∫Øt phim (ch·ªâ l·∫•y t·ª´ h√†ng ƒë·∫ßu ti√™n c√≥)
                if (summary && !movieIndex[filmA].summary) {
                    movieIndex[filmA].summary = summary;
                }
                
                // C·ªôt P (index 15): Link Shopee cho t·ª´ng t·∫≠p
                var shopeeLink = (cells[15] && cells[15].v) ? String(cells[15].v).trim() : "";
                // T·∫≠p 1 lu√¥n kh√¥ng c√≥ Shopee
                if (ep === 1) {
                    shopeeLink = null;
                }
                
                // Ng√†y Upload (c·ªôt F, index 5)
                var uploadDate = (cells[5] && cells[5].v) ? String(cells[5].v).trim() : "";
                
                movieIndex[filmA].episodes.push({ 
                    ep: ep, 
                    embedUrl: embedUrl,
                    shopeeLink: shopeeLink || null,
                    uploadDate: uploadDate || ""
                });

                var allowPCValue = cells[13] && cells[13].v; // C·ªôt N: Xem PC
                if (allowPCValue === true || allowPCValue === 1 || allowPCValue === "TRUE" || allowPCValue === "1") {
                    movieIndex[filmA].allowPC = true;
                }

                if (topRaw != null && !isNaN(topRaw)) {
                    var current = movieIndex[filmA].topRank;
                    movieIndex[filmA].topRank = (current == null) ? topRaw : Math.min(current, topRaw);
                }
                if (poster && !movieIndex[filmA].poster) {
                    movieIndex[filmA].poster = poster;
                }
                
                // Th·ªÉ lo·∫°i (c·ªôt L, index 11)
                var genre = (cells[11] && cells[11].v) ? String(cells[11].v).trim() : "";
                if (genre) {
                    // Lu√¥n c·∫≠p nh·∫≠t genre (c√≥ th·ªÉ c√≥ nhi·ªÅu h√†ng, l·∫•y gi√° tr·ªã ƒë·∫ßu ti√™n)
                    if (!movieIndex[filmA].genre) {
                        movieIndex[filmA].genre = genre;
                        console.log("üìù Set genre cho", filmA, ":", genre);
                    }
                }

                // Collect banners - g·∫Øn v·ªõi phim c·ª• th·ªÉ
                if (banner && banner.startsWith("http")) {
                    // T√¨m banner ƒë√£ t·ªìn t·∫°i (c√πng URL)
                    var existingBannerIndex = -1;
                    for (var i = 0; i < banners.length; i++) {
                        if (typeof banners[i] === 'object' && banners[i].url === banner) {
                            existingBannerIndex = i;
                            break;
                        } else if (typeof banners[i] === 'string' && banners[i] === banner) {
                            existingBannerIndex = i;
                            break;
                        }
                    }
                    
                    if (existingBannerIndex >= 0) {
                        // Banner ƒë√£ t·ªìn t·∫°i ‚Üí update movieId n·∫øu ch∆∞a c√≥
                        if (typeof banners[existingBannerIndex] === 'object') {
                            if (!banners[existingBannerIndex].movieId && filmA) {
                                banners[existingBannerIndex].movieId = filmA;
                            }
                        } else if (typeof banners[existingBannerIndex] === 'string') {
                            // Convert string th√†nh object v√† g·∫Øn movieId
                            banners[existingBannerIndex] = {
                                url: banner,
                                movieId: filmA || null
                            };
                        }
                    } else {
                        // Banner m·ªõi ‚Üí th√™m v√†o
                        banners.push({
                            url: banner,
                            movieId: filmA  // G·∫Øn banner v·ªõi phim n√†y
                        });
                    }
                }
            });

            Object.keys(movieIndex).forEach(function(key) {
                movieIndex[key].episodes.sort(function(a, b) { return a.ep - b.ep; });
            });

            renderTopMovies();
            initGenreTabs(); // Kh·ªüi t·∫°o tabs v√† render phim theo th·ªÉ lo·∫°i
            if (banners.length > 0) {
                renderBanners();
            }

            if (pendingOpen && pendingOpen.id && movieIndex[pendingOpen.id]) {
                loadMovieById(pendingOpen.id, { preferredEp: pendingOpen.ep, fromHash: true });
            }
        })
        .catch(function(e) {
            console.error("L·ªói load sheet fallback:", e);
        });
}

// ========== HELPER: CHECK DEVICE ==========
function isMobileDevice() {
    var ua = navigator.userAgent || navigator.vendor || window.opera;
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile|CriOS/i.test(ua) ||
           (window.innerWidth <= 900 && 'ontouchstart' in window);
}

// ========== HI·ªÇN TH·ªä TOP PHIM (·∫¢NH B√åA) ==========
function renderTopMovies() {
    // Mobile
    var section = document.getElementById('top-section');
    var gridEl = document.getElementById('top-grid');
    // PC (ch·ªâ hi·ªÉn th·ªã, kh√¥ng click)
    var pcSection = document.getElementById('top-section-pc');
    var pcGrid = document.getElementById('top-grid-pc');

    if (gridEl) gridEl.innerHTML = "";
    if (pcGrid) pcGrid.innerHTML = "";

    var isMobile = isMobileDevice();
    var entries = [];
    Object.keys(movieIndex).forEach(function(name) {
        var data = movieIndex[name];
        if (data.topRank != null) {
            // Lu√¥n hi·ªÉn th·ªã TOP tr√™n c·∫£ mobile v√† PC.
            // Tr√™n PC ch·ªâ d√πng ƒë·ªÉ xem poster/ti√™u ƒë·ªÅ, kh√¥ng click xem phim.
            entries.push({ id: name, name: data.displayName || name, rank: data.topRank, poster: data.poster });
        }
    });
    entries.sort(function(a, b) { return a.rank - b.rank; });

    if (!entries.length) {
        if (section) section.style.display = "none";
        if (pcSection) pcSection.style.display = "none";
        return;
    }

    // Helper t·∫°o card
    function createCard(item, clickable) {
        var card = document.createElement('div');
        card.className = 'top-card';
        if (clickable) {
            card.onclick = function() { loadMovieById(item.id); };
        }

        var wrapper = document.createElement('div');
        wrapper.className = 'top-card-wrapper';

        // N·∫øu c√≥ poster th√¨ hi·ªán ·∫£nh, kh√¥ng th√¨ hi·ªán "No Pic"
        if (item.poster && item.poster.trim()) {
            var img = document.createElement('img');
            img.className = 'top-card-img';
            img.src = item.poster;
            img.alt = item.name;
            img.onerror = function() {
                // N·∫øu ·∫£nh l·ªói th√¨ thay b·∫±ng No Pic
                var nopic = document.createElement('div');
                nopic.className = 'top-card-nopic';
                nopic.textContent = 'No Pic';
                this.parentNode.replaceChild(nopic, this);
            };
            wrapper.appendChild(img);
        } else {
            var nopic = document.createElement('div');
            nopic.className = 'top-card-nopic';
            nopic.textContent = 'No Pic';
            wrapper.appendChild(nopic);
        }

        var rankBadge = document.createElement('div');
        rankBadge.className = 'top-card-rank';
        rankBadge.textContent = 'TOP ' + item.rank;
        wrapper.appendChild(rankBadge);

        var nameDiv = document.createElement('div');
        nameDiv.className = 'top-card-name';
        nameDiv.textContent = item.name;

        card.appendChild(wrapper);
        card.appendChild(nameDiv);
        return card;
    }

    entries.forEach(function(item) {
        if (gridEl) {
            gridEl.appendChild(createCard(item, true));   // mobile: c√≥ click
        }
        if (pcGrid) {
            pcGrid.appendChild(createCard(item, true));  // PC: c≈©ng c√≥ click
        }
    });

    if (section) section.style.display = "block";
    if (pcSection) pcSection.style.display = "block";
}

// ========== PHIM THEO TH·ªÇ LO·∫†I ==========
var currentGenreTab = null;
var availableGenres = [];

function initGenreTabs() {
    console.log("üîç initGenreTabs() ƒë∆∞·ª£c g·ªçi");
    console.log("üìä T·ªïng s·ªë phim trong movieIndex:", Object.keys(movieIndex).length);
    
    // Thu th·∫≠p t·∫•t c·∫£ th·ªÉ lo·∫°i t·ª´ movieIndex
    var genreSet = new Set();
    var moviesWithGenre = 0;
    Object.keys(movieIndex).forEach(function(id) {
        var data = movieIndex[id];
        console.log("  Phim:", id, "Genre:", data.genre || "(kh√¥ng c√≥)");
        if (data.genre && data.genre.trim()) {
            genreSet.add(data.genre.trim());
            moviesWithGenre++;
        }
    });
    
    console.log("üìù S·ªë phim c√≥ genre:", moviesWithGenre);
    console.log("üìù C√°c th·ªÉ lo·∫°i t√¨m th·∫•y:", Array.from(genreSet));
    
    availableGenres = Array.from(genreSet).sort();
    
    var tabsContainer = document.getElementById('genre-tabs');
    var section = document.getElementById('genre-section');
    
    if (!tabsContainer) {
        console.log("‚ùå Kh√¥ng t√¨m th·∫•y genre-tabs element");
        return;
    }
    if (!section) {
        console.log("‚ùå Kh√¥ng t√¨m th·∫•y genre-section element");
        return;
    }
    
    tabsContainer.innerHTML = "";
    
    if (availableGenres.length === 0) {
        // Kh√¥ng c√≥ th·ªÉ lo·∫°i n√†o ‚Üí ·∫©n section
        section.style.display = "none";
        console.log("‚ö†Ô∏è Kh√¥ng c√≥ th·ªÉ lo·∫°i n√†o trong d·ªØ li·ªáu ‚Üí ·∫®n section");
        return;
    }
    
    console.log("‚úÖ T√¨m th·∫•y", availableGenres.length, "th·ªÉ lo·∫°i:", availableGenres.join(", "));
    
    // T·∫°o tabs ƒë·ªông
    availableGenres.forEach(function(genre, index) {
        var tab = document.createElement('button');
        tab.className = 'genre-tab' + (index === 0 ? ' active' : '');
        tab.setAttribute('data-genre', genre);
        tab.textContent = genre;
        tab.onclick = function() { switchGenreTab(genre); };
        tabsContainer.appendChild(tab);
    });
    
    // Set tab ƒë·∫ßu ti√™n l√†m active v√† render
    if (availableGenres.length > 0) {
        currentGenreTab = availableGenres[0];
        section.style.display = "block"; // Lu√¥n hi·ªÉn th·ªã section n·∫øu c√≥ th·ªÉ lo·∫°i
        renderGenreMovies(currentGenreTab);
    }
}

function switchGenreTab(genre) {
    currentGenreTab = genre;
    
    // Update active tab
    var tabs = document.querySelectorAll('.genre-tab');
    tabs.forEach(function(tab) {
        if (tab.getAttribute('data-genre') === genre) {
            tab.classList.add('active');
        } else {
            tab.classList.remove('active');
        }
    });
    
    // Render phim theo th·ªÉ lo·∫°i
    renderGenreMovies(genre);
}

function renderGenreMovies(genre) {
    var gridEl = document.getElementById('genre-grid');
    if (!gridEl) {
        console.log("‚ùå Kh√¥ng t√¨m th·∫•y genre-grid element");
        return;
    }
    
    gridEl.innerHTML = "";
    
    var entries = [];
    var totalMovies = 0;
    var matchedMovies = 0;
    
    Object.keys(movieIndex).forEach(function(id) {
        var data = movieIndex[id];
        totalMovies++;
        
        // Debug: log genre c·ªßa t·ª´ng phim
        if (data.genre) {
            console.log("Phim:", data.displayName || id, "Genre:", data.genre);
        }
        
        // Ki·ªÉm tra th·ªÉ lo·∫°i kh·ªõp
        if (data.genre && data.genre.trim() === genre) {
            matchedMovies++;
            // L·∫•y uploadDate m·ªõi nh·∫•t t·ª´ episodes
            var latestUploadDate = null;
            if (data.episodes && data.episodes.length > 0) {
                data.episodes.forEach(function(ep) {
                    if (ep.uploadDate && ep.uploadDate.trim()) {
                        var epDate = ep.uploadDate.trim();
                        if (!latestUploadDate || epDate > latestUploadDate) {
                            latestUploadDate = epDate;
                        }
                    }
                });
            }
            
            entries.push({
                id: id,
                name: data.displayName || id,
                poster: data.poster,
                uploadDate: latestUploadDate || '1970-01-01' // N·∫øu kh√¥ng c√≥ date th√¨ ƒë·∫∑t m·∫∑c ƒë·ªãnh c≈©
            });
        }
    });
    
    // Debug log
    console.log("üé¨ Render genre:", genre, "T·ªïng phim:", totalMovies, "Kh·ªõp:", matchedMovies, "Entries:", entries.length);
    
    // S·∫Øp x·∫øp theo uploadDate m·ªõi nh·∫•t (gi·∫£m d·∫ßn)
    entries.sort(function(a, b) {
        return b.uploadDate.localeCompare(a.uploadDate);
    });
    
    if (!entries.length) {
        gridEl.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">Ch∆∞a c√≥ phim th·ªÉ lo·∫°i "' + genre + '"</div>';
        // V·∫´n hi·ªÉn th·ªã section ƒë·ªÉ user bi·∫øt
        var section = document.getElementById('genre-section');
        if (section) section.style.display = "block";
        return;
    }
    
    // Helper t·∫°o card (gi·ªëng TOP)
    function createGenreCard(item) {
        var card = document.createElement('div');
        card.className = 'top-card';
        card.onclick = function() { loadMovieById(item.id); };

        var wrapper = document.createElement('div');
        wrapper.className = 'top-card-wrapper';

        // N·∫øu c√≥ poster th√¨ hi·ªán ·∫£nh, kh√¥ng th√¨ hi·ªán "No Pic"
        if (item.poster && item.poster.trim()) {
            var img = document.createElement('img');
            img.className = 'top-card-img';
            img.src = item.poster;
            img.alt = item.name;
            img.onerror = function() {
                // N·∫øu ·∫£nh l·ªói th√¨ thay b·∫±ng No Pic
                var nopic = document.createElement('div');
                nopic.className = 'top-card-nopic';
                nopic.textContent = 'No Pic';
                this.parentNode.replaceChild(nopic, this);
            };
            wrapper.appendChild(img);
        } else {
            var nopic = document.createElement('div');
            nopic.className = 'top-card-nopic';
            nopic.textContent = 'No Pic';
            wrapper.appendChild(nopic);
        }

        var nameDiv = document.createElement('div');
        nameDiv.className = 'top-card-name';
        nameDiv.textContent = item.name;

        card.appendChild(wrapper);
        card.appendChild(nameDiv);
        return card;
    }
    
    entries.forEach(function(item) {
        gridEl.appendChild(createGenreCard(item));
    });
    
    // Hi·ªÉn th·ªã section (lu√¥n hi·ªÉn th·ªã, d√π c√≥ phim hay kh√¥ng)
    var section = document.getElementById('genre-section');
    if (section) {
        section.style.display = "block";
        console.log("‚úÖ Hi·ªÉn th·ªã genre-section v·ªõi", entries.length, "phim");
    } else {
        console.log("‚ùå Kh√¥ng t√¨m th·∫•y genre-section element");
    }
}

// ========== BANNER CAROUSEL ==========
var currentBannerIndex = 0;
var bannerInterval = null;

function renderBanners() {
    var container = document.getElementById('banner-carousel');
    var wrapper = document.querySelector('.banner-wrapper');
    var dots = document.querySelector('.banner-dots');
    
    if (!container || !wrapper || !dots || banners.length === 0) {
        if (container) container.style.display = "none";
        return;
    }

    wrapper.innerHTML = "";
    dots.innerHTML = "";
    currentBannerIndex = 0;

    banners.forEach(function(bannerItem, index) {
        // Banner c√≥ th·ªÉ l√† object {url, movieId} ho·∫∑c string (backward compatibility)
        var bannerUrl = typeof bannerItem === 'object' ? bannerItem.url : bannerItem;
        var movieId = typeof bannerItem === 'object' ? bannerItem.movieId : null;
        
        // Slide
        var slide = document.createElement('div');
        slide.className = 'banner-slide';
        slide.style.transform = `translateX(${index * 100}%)`;
        
        // N·∫øu c√≥ movieId th√¨ l√†m cho clickable
        if (movieId && movieIndex[movieId]) {
            slide.style.cursor = 'pointer';
            slide.onclick = function() {
                // Click v√†o banner ‚Üí m·ªü phim ƒë√≥
                loadMovieById(movieId);
            };
        }
        
        var img = document.createElement('img');
        img.src = bannerUrl;
        img.alt = `Banner ${index + 1}`;
        img.onerror = function() {
            this.style.display = 'none';
        };
        
        slide.appendChild(img);
        wrapper.appendChild(slide);
        
        // Dot
        var dot = document.createElement('div');
        dot.className = 'banner-dot' + (index === 0 ? ' active' : '');
        dot.onclick = function() { goToBanner(index); };
        dots.appendChild(dot);
    });

    container.style.display = "block";
    updateBannerPosition();
    startAutoSlide();
}

function goToBanner(index) {
    currentBannerIndex = index;
    updateBannerPosition();
    resetAutoSlide();
}

function nextBanner() {
    currentBannerIndex = (currentBannerIndex + 1) % banners.length;
    updateBannerPosition();
}

function prevBanner() {
    currentBannerIndex = (currentBannerIndex - 1 + banners.length) % banners.length;
    updateBannerPosition();
}

function updateBannerPosition() {
    var wrapper = document.querySelector('.banner-wrapper');
    if (!wrapper) return;
    
    wrapper.style.transform = `translateX(-${currentBannerIndex * 100}%)`;
    
    var dots = document.querySelectorAll('.banner-dot');
    dots.forEach(function(dot, index) {
        dot.classList.toggle('active', index === currentBannerIndex);
    });
}

function startAutoSlide() {
    stopAutoSlide();
    if (banners.length <= 1) return;
    bannerInterval = setInterval(function() {
        nextBanner();
    }, 5000); // ƒê·ªïi banner m·ªói 5 gi√¢y
}

function stopAutoSlide() {
    if (bannerInterval) {
        clearInterval(bannerInterval);
        bannerInterval = null;
    }
}

function resetAutoSlide() {
    stopAutoSlide();
    startAutoSlide();
}

// Event listeners cho banner
document.addEventListener('DOMContentLoaded', function() {
    var bannerContainer = document.getElementById('banner-carousel');
    if (bannerContainer) {
        bannerContainer.addEventListener('mouseenter', stopAutoSlide);
        bannerContainer.addEventListener('mouseleave', startAutoSlide);
        
        var nextBtn = bannerContainer.querySelector('.banner-next');
        var prevBtn = bannerContainer.querySelector('.banner-prev');
        
        if (nextBtn) {
            nextBtn.addEventListener('click', function() {
                nextBanner();
                resetAutoSlide();
            });
        }
        if (prevBtn) {
            prevBtn.addEventListener('click', function() {
                prevBanner();
                resetAutoSlide();
            });
        }
        
        // Swipe tr√™n mobile
        var touchStartX = 0;
        var touchEndX = 0;
        
        bannerContainer.addEventListener('touchstart', function(e) {
            touchStartX = e.changedTouches[0].screenX;
            stopAutoSlide();
        });
        
        bannerContainer.addEventListener('touchend', function(e) {
            touchEndX = e.changedTouches[0].screenX;
            if (touchEndX < touchStartX - 50) {
                nextBanner(); // Swipe left = next
            }
            if (touchEndX > touchStartX + 50) {
                prevBanner(); // Swipe right = prev
            }
            startAutoSlide();
        });
    }
});

// ========== T√åM KI·∫æM ==========
function renderSearchResults(keyword) {
    var box = document.getElementById('search-results');
    if (!box) return;

    var qNorm = normalizeText(keyword);
    box.innerHTML = "";
    if (!qNorm) {
        box.style.display = "none";
        return;
    }

    var isMobile = isMobileDevice();
    var names = Object.keys(movieIndex)
        .map(function(id) { return { id: id, name: (movieIndex[id].displayName || id), allowPC: movieIndex[id].allowPC }; })
        .filter(function(item) {
            // N·∫øu l√† PC v√† phim kh√¥ng allow PC th√¨ b·ªè qua
            if (!isMobile && !item.allowPC) {
                return false;
            }
            return normalizeText(item.name).includes(qNorm);
        });

    if (!names.length) {
        box.innerHTML = '<div class="search-result-item">Kh√¥ng t√¨m th·∫•y phim ph√π h·ª£p.</div>';
        box.style.display = "block";
        return;
    }

    names.slice(0, 30).forEach(function(item) {
        var div = document.createElement('div');
        div.className = 'search-result-item';
        div.textContent = item.name;
        div.onclick = function() {
            box.style.display = "none";
            document.getElementById('search-input').value = item.name;
            loadMovieById(item.id);
        };
        box.appendChild(div);
    });
    box.style.display = "block";
}

// ========== LOAD PHIM ==========
function getFirstEpisodeObj(episodes, preferredEp) {
    if (!episodes || !episodes.length) return null;
    // N·∫øu preferredEp l√† "FULL" ‚Üí t√¨m episode c√≥ ep === "FULL"
    if (preferredEp === 'FULL' || preferredEp === 'full' || String(preferredEp).toUpperCase() === 'FULL') {
        for (var i = 0; i < episodes.length; i++) {
            if (episodes[i].ep === 'FULL' || episodes[i].ep === 'full') return episodes[i];
        }
    }
    var epNum = Number(preferredEp);
    if (!isNaN(epNum)) {
        for (var i = 0; i < episodes.length; i++) {
            if (Number(episodes[i].ep) === epNum) return episodes[i];
        }
    }
    return episodes[0];
}

function setUrlState(id, ep) {
    try {
        var safeId = encodeURIComponent(String(id || ""));
        var safeEp = encodeURIComponent(String(ep || ""));
        // d·∫°ng: #m=<id>&e=<ep>
        window.location.hash = "m=" + safeId + "&e=" + safeEp;
    } catch (e) {
        // ignore
    }
}

function parseUrlState() {
    var h = (window.location.hash || "").replace(/^#/, "").trim();
    if (!h) return null;
    // support m=<id>&e=<ep>
    var out = {};
    h.split("&").forEach(function(part) {
        var kv = part.split("=");
        if (kv.length < 2) return;
        var k = decodeURIComponent(kv[0] || "").trim();
        var v = decodeURIComponent(kv.slice(1).join("=") || "").trim();
        out[k] = v;
    });
    if (out.m) {
        return { id: out.m, ep: out.e ? Number(out.e) : null };
    }
    return null;
}

function loadMovieById(id, opts) {
    opts = opts || {};
    var data = movieIndex[id];
    if (!data || !data.episodes.length) return;
    
    // N·∫øu l√† PC v√† phim kh√¥ng allow PC th√¨ block
    if (!isMobileDevice() && !data.allowPC) {
        alert("Phim n√†y ch·ªâ xem ƒë∆∞·ª£c tr√™n thi·∫øt b·ªã di ƒë·ªông. Vui l√≤ng m·ªü tr√™n mobile ƒë·ªÉ xem.");
        return;
    }

    var episodes = data.episodes;
    var epList = document.getElementById('episode-list');
    if (!epList) return;

    epList.innerHTML = "";

    // T√¨m shopeeLink cho m·ªói t·∫≠p (k·∫ø th·ª´a t·ª´ t·∫≠p tr∆∞·ªõc n·∫øu kh√¥ng c√≥)
    var lastShopeeLink = myShopeeLink; // M·∫∑c ƒë·ªãnh
    episodes.forEach(function(item, index) {
        // N·∫øu t·∫≠p n√†y c√≥ shopeeLink ri√™ng th√¨ d√πng, kh√¥ng th√¨ k·∫ø th·ª´a t·ª´ t·∫≠p tr∆∞·ªõc
        if (item.shopeeLink && item.shopeeLink.trim()) {
            lastShopeeLink = item.shopeeLink.trim();
        } else if (item.ep > 1) {
            // T·ª´ t·∫≠p 2 tr·ªü ƒëi, n·∫øu kh√¥ng c√≥ link ri√™ng th√¨ d√πng link c·ªßa t·∫≠p tr∆∞·ªõc
            item.shopeeLink = lastShopeeLink;
        }
        // T·∫≠p 1 lu√¥n kh√¥ng c√≥ shopeeLink (null)
        if (item.ep === 1) {
            item.shopeeLink = null;
        }
    });

    episodes.forEach(function(item) {
        var div = document.createElement('div');
        div.className = 'ep-item';
        // Hi·ªÉn th·ªã "FULL" n·∫øu ep l√† "FULL", ng∆∞·ª£c l·∫°i hi·ªÉn th·ªã "T·∫≠p X"
        if (item.ep === 'FULL' || item.ep === 'full') {
            div.textContent = "FULL";
        } else {
            div.textContent = "T·∫≠p " + item.ep;
        }
        div.onclick = function() {
            var clickedDiv = this; // L∆∞u reference ƒë·∫øn div element
            var epNum = Number(item.ep);
            var isEp2Plus = !isNaN(epNum) && epNum > 1;
            var hasShopeeLink = item.shopeeLink && item.shopeeLink.trim() && item.shopeeLink.trim() !== 'null';
            
            // Ki·ªÉm tra embedUrl c√≥ ph·∫£i l√† Dailymotion embed kh√¥ng
            var embedUrlStr = item.embedUrl ? String(item.embedUrl).trim() : '';
            var isDailymotionEmbed = embedUrlStr && (
                embedUrlStr.includes('geo.dailymotion.com') || 
                embedUrlStr.includes('dailymotion.com/embed') ||
                embedUrlStr.includes('dailymotion.com/player.html')
            );
            
            // Ki·ªÉm tra c√≥ videoUrl l√† link fanpage/YouTube kh√¥ng
            var videoUrlStr = item.videoUrl ? String(item.videoUrl).trim() : '';
            var isExternalLink = videoUrlStr && (
                videoUrlStr.includes('facebook.com') || 
                videoUrlStr.includes('fb.com') || 
                videoUrlStr.includes('/reel/') ||
                videoUrlStr.includes('youtube.com') || 
                videoUrlStr.includes('youtu.be')
            );
            
            // Logic: N·∫øu l√† t·∫≠p 2+ v√† c√≥ embed Dailymotion ‚Üí m·ªü Shopee ‚Üí m·ªü YouTube redirect
            if (isEp2Plus && isDailymotionEmbed && hasShopeeLink) {
                // M·ªü Shopee link trong tab m·ªõi
                var shopeeUrl = item.shopeeLink.trim();
                window.open(shopeeUrl, '_blank');
                
                // Sau ƒë√≥ m·ªü YouTube redirect link t·ª´ config
                var youtubeRedirectUrl = (siteConfig && siteConfig.social && siteConfig.social.youtubeRedirect) 
                    ? siteConfig.social.youtubeRedirect 
                    : "https://youtube.com/channel/UCb35SXg3vJeYP5povmGHA1A?sub_confirmation=1";
                setTimeout(function() {
                    window.open(youtubeRedirectUrl, '_blank');
                }, 300);
                
                // KH√îNG chuy·ªÉn sang t·∫≠p ƒë√≥ n·ªØa - ch·ªâ m·ªü Shopee v√† YouTube
                return;
            } else if (isEp2Plus && hasShopeeLink && !isDailymotionEmbed) {
                // T·∫≠p 2+ c√≥ Shopee link nh∆∞ng KH√îNG ph·∫£i embed Dailymotion (c√≥ th·ªÉ l√† link fanpage/YouTube)
                // ‚Üí Gi·ªØ nguy√™n logic c≈©: m·ªü Shopee ‚Üí chuy·ªÉn t·∫≠p
                var shopeeUrl = item.shopeeLink.trim();
                window.open(shopeeUrl, '_blank');
                changeEpisode(item.ep, item.embedUrl, data.displayName || id, clickedDiv, id, item.shopeeLink, item.videoUrl);
            } else {
                // T·∫≠p 1 ho·∫∑c kh√¥ng c√≥ Shopee link ‚Üí chuy·ªÉn t·∫≠p b√¨nh th∆∞·ªùng
                changeEpisode(item.ep, item.embedUrl, data.displayName || id, clickedDiv, id, item.shopeeLink, item.videoUrl);
            }
        };
        epList.appendChild(div);
    });

    var first = getFirstEpisodeObj(episodes, opts.preferredEp);
    var movieSection = document.getElementById('movie-section');
    if (movieSection) movieSection.style.display = 'block';

    // Hi·ªÉn th·ªã t√≥m t·∫Øt phim
    var summaryEl = document.getElementById('film-summary');
    var summaryToggle = document.getElementById('film-summary-toggle');
    if (summaryEl && summaryToggle) {
        var summaryText = (data.summary || "").trim();
        if (summaryText) {
            summaryEl.textContent = summaryText;
            summaryEl.classList.remove('expanded');
            summaryEl.style.display = '-webkit-box';

            // Hi·ªÉn th·ªã n√∫t Xem th√™m / Thu g·ªçn
            summaryToggle.style.display = 'block';
            summaryToggle.dataset.expanded = 'false';
            summaryToggle.querySelector('span').textContent = 'Xem th√™m';

            summaryToggle.onclick = function () {
                var isExpanded = summaryToggle.dataset.expanded === 'true';
                if (isExpanded) {
                    summaryEl.classList.remove('expanded');
                    summaryEl.style.display = '-webkit-box';
                    summaryToggle.querySelector('span').textContent = 'Xem th√™m';
                    summaryToggle.dataset.expanded = 'false';
                } else {
                    summaryEl.classList.add('expanded');
                    summaryToggle.querySelector('span').textContent = 'Thu g·ªçn';
                    summaryToggle.dataset.expanded = 'true';
                }
            };
        } else {
            summaryEl.style.display = 'none';
            summaryToggle.style.display = 'none';
        }
    }

    // Scroll l√™n player
    movieSection.scrollIntoView({ behavior: 'smooth' });

    // active ƒë√∫ng t·∫≠p
    var activeEl = null;
    for (var i = 0; i < epList.children.length; i++) {
        var txt = epList.children[i].textContent || "";
        var firstEpText = (first.ep === 'FULL' || first.ep === 'full') ? 'FULL' : ("t·∫≠p" + String(first.ep));
        if (txt.replace(/\s+/g, '').toLowerCase() === firstEpText.replace(/\s+/g, '').toLowerCase()) {
            activeEl = epList.children[i];
            break;
        }
    }
    changeEpisode(first.ep, first.embedUrl, data.displayName || id, activeEl || epList.firstChild, id, first.shopeeLink, first.videoUrl);

    // set hash ƒë·ªÉ back/reload v·∫´n ƒë√∫ng phim/t·∫≠p
    if (!opts.fromHash) {
        setUrlState(id, first.ep);
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Load site config (donate, social links, meta) tr∆∞·ªõc
    loadSiteConfig();
    
    var input = document.getElementById('search-input');
    if (input) {
        input.addEventListener('input', function() { renderSearchResults(input.value); });
    }
    pendingOpen = parseUrlState();
    loadMoviesFromJSON(); // Load t·ª´ JSON (export t·ª´ Sheet)
});

// ========== SHOPEE & PLAYER ==========
var myShopeeLink = "https://s.shopee.vn/9pXNbUiEFE"; // Link m·∫∑c ƒë·ªãnh (fallback)
var currentShopeeLink = myShopeeLink; // Link Shopee c·ªßa t·∫≠p hi·ªán t·∫°i

// handlePlay() ƒë√£ ƒë∆∞·ª£c x√≥a v√¨ overlay Shopee ƒë√£ ƒë∆∞·ª£c t·∫Øt ho√†n to√†n


var currentExternalVideoUrl = null;

function openExternalVideo() {
    if (currentExternalVideoUrl) {
        // T·∫§T C·∫¢ t·∫≠p (bao g·ªìm t·∫≠p 1) ‚Üí m·ªü Shopee tr∆∞·ªõc (n·∫øu c√≥), sau ƒë√≥ m·ªü link
        var shopeeLink = currentShopeeLink || myShopeeLink;
        
        // Ki·ªÉm tra shopeeLink c√≥ h·ª£p l·ªá kh√¥ng (kh√¥ng r·ªóng, kh√¥ng null, kh√¥ng undefined)
        if (shopeeLink && shopeeLink.trim() && shopeeLink.trim() !== 'null' && shopeeLink.trim() !== 'undefined' && shopeeLink.trim() !== '') {
            console.log("T·∫≠p " + currentEpisode + " - M·ªü Shopee tr∆∞·ªõc:", shopeeLink);
            window.open(shopeeLink.trim(), "_blank");
            // ƒê·ª£i 500ms r·ªìi m·ªü link
            setTimeout(function() {
                console.log("T·∫≠p " + currentEpisode + " - M·ªü link sau:", currentExternalVideoUrl);
                window.open(currentExternalVideoUrl, "_blank");
            }, 500);
        } else {
            // Kh√¥ng c√≥ Shopee link ho·∫∑c Shopee link r·ªóng ‚Üí m·ªü link lu√¥n
            console.log("T·∫≠p " + currentEpisode + " - Kh√¥ng c√≥ Shopee link, m·ªü link lu√¥n:", currentExternalVideoUrl);
            window.open(currentExternalVideoUrl, "_blank");
        }
    } else {
        console.log("T·∫≠p " + currentEpisode + " - Kh√¥ng c√≥ currentExternalVideoUrl, kh√¥ng m·ªü g√¨");
    }
}

function changeEpisode(epNum, source, filmNameOverride, clickedEl, movieId, shopeeLink, videoUrl) {
    var overlay = document.getElementById('overlay');
    var player = document.getElementById('video-player');
    var placeholder = document.getElementById('external-video-placeholder');
    var placeholderThumb = document.getElementById('external-video-thumbnail');
    
    // X·ª≠ l√Ω "FULL" - gi·ªØ nguy√™n string, kh√¥ng convert sang s·ªë
    if (epNum === 'FULL' || epNum === 'full' || String(epNum).toUpperCase() === 'FULL') {
        currentEpisode = 'FULL';
    } else {
        currentEpisode = Number(epNum);
    }
    
    // Ki·ªÉm tra embedUrl v√† videoUrl tr∆∞·ªõc
    var videoUrlStr = videoUrl ? String(videoUrl).trim() : '';
    var embedUrlStr = source ? String(source).trim() : '';
    
    // N·∫øu videoUrl r·ªóng nh∆∞ng embedUrl l√† link Facebook/reel ‚Üí d√πng embedUrl l√†m videoUrl
    if (!videoUrlStr && embedUrlStr) {
        if (embedUrlStr.includes('facebook.com') || embedUrlStr.includes('fb.com') || embedUrlStr.includes('/reel/') || embedUrlStr.includes('youtube.com') || embedUrlStr.includes('youtu.be')) {
            videoUrlStr = embedUrlStr;
            console.log(`T·∫≠p ${currentEpisode} - D√πng embedUrl l√†m videoUrl (Facebook/YouTube link):`, videoUrlStr);
        }
    }
    
    // Ki·ªÉm tra embedUrl c√≥ ph·∫£i l√† Dailymotion embed chu·∫©n kh√¥ng
    var isDailymotionEmbed = embedUrlStr && (
        embedUrlStr.includes('geo.dailymotion.com') || 
        embedUrlStr.includes('dailymotion.com/embed') ||
        embedUrlStr.includes('dailymotion.com/player.html')
    );
    
    // N·∫øu c√≥ c·∫£ embed Dailymotion V√Ä link fanpage/YouTube ‚Üí ∆∞u ti√™n embed Dailymotion, b·ªè qua link fanpage
    // Ch·ªâ d√πng link fanpage/YouTube n·∫øu KH√îNG c√≥ embed Dailymotion
    var shouldUseExternalLink = false;
    if (videoUrlStr && videoUrlStr.length > 0 && videoUrlStr.startsWith("http")) {
        if (!isDailymotionEmbed) {
            // Kh√¥ng c√≥ embed Dailymotion ‚Üí d√πng link fanpage/YouTube
            shouldUseExternalLink = true;
        } else {
            // C√≥ embed Dailymotion ‚Üí b·ªè qua link fanpage/YouTube, ∆∞u ti√™n embed
            console.log(`T·∫≠p ${currentEpisode} - C√≥ c·∫£ embed Dailymotion v√† link fanpage, ∆∞u ti√™n embed Dailymotion`);
            videoUrlStr = ''; // B·ªè qua link fanpage
        }
    }
    
    // Debug log
    if (videoUrlStr && (videoUrlStr.includes('facebook') || videoUrlStr.includes('youtube'))) {
        console.log(`T·∫≠p ${currentEpisode} - videoUrl:`, videoUrlStr, "embedUrl:", embedUrlStr, "isDailymotionEmbed:", isDailymotionEmbed);
    }
    
    // Set link Shopee cho t·∫≠p n√†y
    // T·∫•t c·∫£ t·∫≠p: n·∫øu c√≥ link fanpage/YouTube (v√† kh√¥ng c√≥ embed Dailymotion) ‚Üí c√≥ Shopee
    // T·∫≠p 1: n·∫øu c√≥ embed Dailymotion ‚Üí kh√¥ng c√≥ Shopee
    // T·∫≠p 2+: n·∫øu c√≥ embed Dailymotion ‚Üí c√≥ Shopee (trong overlay)
    // FULL: n·∫øu c√≥ embed Dailymotion ‚Üí kh√¥ng c√≥ Shopee (xem tr·ª±c ti·∫øp, kh√¥ng c√≥ overlay)
    if (shouldUseExternalLink) {
        // C√≥ link fanpage/YouTube (kh√¥ng c√≥ embed Dailymotion) ‚Üí t·∫•t c·∫£ t·∫≠p (bao g·ªìm FULL) ƒë·ªÅu c√≥ Shopee
        currentShopeeLink = (shopeeLink && shopeeLink.trim() && shopeeLink.trim() !== 'null') ? shopeeLink.trim() : myShopeeLink;
        console.log(`T·∫≠p ${currentEpisode} - C√≥ link fanpage/YouTube ‚Üí Shopee link:`, currentShopeeLink ? 'C√ì' : 'KH√îNG');
    } else if (isDailymotionEmbed) {
        // C√≥ embed Dailymotion
        if (currentEpisode === 1 || currentEpisode === 'FULL') {
            // T·∫≠p 1 ho·∫∑c FULL c√≥ embed Dailymotion ‚Üí kh√¥ng c√≥ Shopee (xem tr·ª±c ti·∫øp)
            currentShopeeLink = null;
        } else {
            // T·∫≠p 2+ c√≥ embed Dailymotion ‚Üí c√≥ Shopee (trong overlay)
            currentShopeeLink = (shopeeLink && shopeeLink.trim() && shopeeLink.trim() !== 'null') ? shopeeLink.trim() : myShopeeLink;
        }
        console.log(`T·∫≠p ${currentEpisode} - C√≥ embed Dailymotion ‚Üí Shopee link:`, currentShopeeLink ? 'C√ì' : 'KH√îNG');
    } else {
        // Kh√¥ng c√≥ g√¨
        currentShopeeLink = null;
    }
    
    // Overlay Shopee ƒë√£ ƒë∆∞·ª£c t·∫Øt ho√†n to√†n - lu√¥n ·∫©n
    if (overlay) {
        overlay.style.display = 'none';
    }
    
    // N·∫øu c√≥ link fanpage/YouTube (v√† kh√¥ng c√≥ embed Dailymotion) ‚Üí hi·ªÉn th·ªã placeholder (cho T·∫§T C·∫¢ t·∫≠p)
    if (shouldUseExternalLink && videoUrlStr && videoUrlStr.length > 0 && videoUrlStr.startsWith("http")) {
        currentExternalVideoUrl = videoUrlStr;
        console.log(`T·∫≠p ${currentEpisode} c√≥ videoUrl ngo√†i ‚Üí hi·ªÉn th·ªã placeholder:`, videoUrlStr);
        
        // ·∫®n iframe, hi·ªán placeholder
        if (player) player.style.display = 'none';
        if (placeholder) {
            placeholder.classList.add('active');
            console.log(`T·∫≠p ${currentEpisode} - Placeholder ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t`);
            
            // ƒê·∫£m b·∫£o n√∫t play v√† label LU√îN hi·ªÉn th·ªã (d√π c√≥ poster hay kh√¥ng)
            var playBtn = document.getElementById('external-video-play-btn');
            var label = document.getElementById('external-video-label');
            if (playBtn) {
                playBtn.style.display = 'flex';
                playBtn.style.visibility = 'visible';
                playBtn.style.opacity = '1';
                console.log(`T·∫≠p ${currentEpisode} - N√∫t play ƒë√£ hi·ªÉn th·ªã`);
            }
            if (label) {
                // T·∫≠p 1: "Xem tr√™n Fanpage/YouTube", T·∫≠p 2+ v√† FULL: "M·ªü Shopee & Xem"
                if (currentEpisode === 1) {
                    // X√°c ƒë·ªãnh lo·∫°i link ƒë·ªÉ hi·ªÉn th·ªã label ph√π h·ª£p
                    if (videoUrlStr.includes('facebook.com') || videoUrlStr.includes('fb.com')) {
                        label.textContent = 'Xem tr√™n Fanpage';
                    } else if (videoUrlStr.includes('youtube.com') || videoUrlStr.includes('youtu.be')) {
                        label.textContent = 'Xem tr√™n YouTube';
                    } else {
                        label.textContent = 'Xem video';
                    }
                } else if (currentEpisode === 'FULL') {
                    label.textContent = 'üõí M·ªü Shopee & Xem FULL';
                } else {
                    // T·∫≠p 2+: X√°c ƒë·ªãnh lo·∫°i link
                    if (videoUrlStr.includes('facebook.com') || videoUrlStr.includes('fb.com')) {
                        label.textContent = 'üõí M·ªü Shopee & Xem tr√™n Fanpage';
                    } else if (videoUrlStr.includes('youtube.com') || videoUrlStr.includes('youtu.be')) {
                        label.textContent = 'üõí M·ªü Shopee & Xem tr√™n YouTube';
                    } else {
                        label.textContent = 'üõí M·ªü Shopee & Xem video';
                    }
                }
                label.style.display = 'block';
                label.style.visibility = 'visible';
                label.style.opacity = '1';
                console.log(`T·∫≠p ${currentEpisode} - Label ƒë√£ hi·ªÉn th·ªã`);
            }
            
            // L·∫•y poster t·ª´ movieIndex n·∫øu c√≥
            if (movieId && movieIndex[movieId] && movieIndex[movieId].poster) {
                var posterUrl = movieIndex[movieId].poster.trim();
                if (posterUrl) {
                    console.log(`T·∫≠p ${currentEpisode} - Set poster:`, posterUrl);
                    placeholderThumb.src = posterUrl;
                    placeholderThumb.style.display = 'block';
                    placeholderThumb.onerror = function() {
                        console.log(`T·∫≠p ${currentEpisode} - Poster load error, ·∫©n thumbnail`);
                        this.style.display = 'none';
                    };
                } else {
                    console.log(`T·∫≠p ${currentEpisode} - Kh√¥ng c√≥ poster URL, ·∫©n thumbnail`);
                    placeholderThumb.style.display = 'none';
                }
            } else {
                console.log(`T·∫≠p ${currentEpisode} - Kh√¥ng t√¨m th·∫•y movieId ho·∫∑c poster trong movieIndex, ·∫©n thumbnail`);
                placeholderThumb.style.display = 'none';
            }
        } else {
            console.log(`T·∫≠p ${currentEpisode} - L·ªñI: Kh√¥ng t√¨m th·∫•y placeholder element!`);
        }
    } else {
        // Kh√¥ng c√≥ link fanpage/YouTube ‚Üí d√πng Dailymotion player (n·∫øu c√≥ embedUrl Dailymotion)
        currentExternalVideoUrl = null;
        if (placeholder) placeholder.classList.remove('active');
        
        // Ch·ªâ hi·ªÉn th·ªã player n·∫øu c√≥ embedUrl Dailymotion chu·∫©n
        if (isDailymotionEmbed && embedUrlStr) {
            if (player) {
                player.style.display = 'block';
                var src = String(embedUrlStr);
                // ƒê·∫£m b·∫£o embedUrl c√≥ autoplay
                if (!src.includes('autoplay=')) {
                    src += (src.includes('?') ? '&' : '?') + 'autoplay=1&mute=0';
                }
                player.src = src;
                console.log(`T·∫≠p ${currentEpisode} - Hi·ªÉn th·ªã Dailymotion player:`, src);
            }
        } else {
            // Kh√¥ng c√≥ embedUrl Dailymotion ‚Üí ·∫©n player
            if (player) {
                player.style.display = 'none';
                console.log(`T·∫≠p ${currentEpisode} - Kh√¥ng c√≥ embedUrl Dailymotion, ·∫©n player`);
            }
        }
    }

    // Hi·ªÉn th·ªã title: "FULL" ho·∫∑c "T·∫≠p X"
    var displayTitle;
    if (epNum === 'FULL' || epNum === 'full' || String(epNum).toUpperCase() === 'FULL') {
        displayTitle = "FULL";
    } else {
        displayTitle = "T·∫≠p " + epNum;
    }
    var filmName = filmNameOverride || "T√™n Phim";
    document.getElementById('film-title').innerText = displayTitle + " - " + filmName;

    var eps = document.getElementsByClassName('ep-item');
    for (var i = 0; i < eps.length; i++) { eps[i].classList.remove('active'); }
    if (clickedEl) clickedEl.classList.add('active');

    // L∆∞u state l√™n URL ƒë·ªÉ in-app browser back/reload kh√¥ng m·∫•t t·∫≠p
    if (movieId) {
        setUrlState(movieId, currentEpisode);
    }
        }
    </script>

</body>
</html>
